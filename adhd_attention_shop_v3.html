<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADHD ä¸“æ³¨è§„åˆ’å™¨ v3.0 (å•†åº—ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #F4F7F6;
            --text-color: #2C3E50;
            --primary-action: #FF6B6B;
            --focus-color: #1DD1A1;
            --gold-color: #FDCB6E;
            --card-bg: #FFFFFF;
            --danger-color: #e74c3c;
            --shop-card-bg: #FFF8E1;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* --- é¡¶éƒ¨å¯¼èˆªæ  --- */
        .header {
            width: 100%;
            max-width: 450px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            box-sizing: border-box;
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .coin-display {
            font-weight: 800;
            color: #E67E22;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn {
            background: none;
            border: 2px solid #EEE;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #7f8c8d;
            transition: all 0.2s;
            margin-right: 5px;
        }
        .nav-btn:hover, .nav-btn.active { background: #f0f0f0; color: #333; border-color: #ccc; }

        /* --- ä¸»å®¹å™¨ --- */
        .container {
            width: 100%;
            max-width: 450px;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: center;
            transition: all 0.3s ease;
            box-sizing: border-box;
            margin-bottom: 50px;
        }

        h2 { margin-top: 0; color: var(--text-color); font-size: 1.5rem; }
        
        /* --- è¾“å…¥æ¡†ä¸æ§ä»¶ --- */
        input[type="text"], input[type="number"], input[type="url"] {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #F0F0F0;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus { border-color: var(--primary-action); outline: none; }
        input[type="range"] { width: 100%; margin: 25px 0; cursor: pointer; }

        /* --- æŒ‰é’® --- */
        .btn {
            width: 100%;
            padding: 16px;
            background-color: var(--primary-action);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background-color: #95A5A6; }
        .btn-finish { background-color: var(--focus-color); }
        .btn-close { background: #eee; color: #666; margin-top: 10px; }

        /* --- å•†åº—ç½‘æ ¼å¸ƒå±€ --- */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .shop-item {
            background: #FAFAFA;
            border: 2px solid #EEE;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .shop-item:hover {
            border-color: var(--gold-color);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(253, 203, 110, 0.2);
        }

        .shop-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .shop-icon img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .shop-name { font-weight: bold; font-size: 0.95rem; margin-bottom: 5px; color: #34495e; }
        .shop-price { color: #E67E22; font-weight: 800; font-size: 0.9rem; }
        
        .delete-item-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.2rem;
            cursor: pointer;
            line-height: 1;
        }
        .delete-item-btn:hover { color: var(--danger-color); }

        /* --- å€’è®¡æ—¶ä¸å†å²è®°å½•æ ·å¼ --- */
        .timer-display {
            font-size: 4.5rem;
            font-weight: 800;
            color: var(--focus-color);
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
        }
        .history-list { max-height: 400px; overflow-y: auto; text-align: left; }
        .history-card {
            background: #F8F9FA;
            border-left: 5px solid #DDD;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
        }
        .history-card.perfect { border-left-color: var(--gold-color); background: #FEF9E7; }
        .hidden { display: none !important; }
        
        /* åŠ¨ç”» */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .shake-anim { animation: shake 0.3s; }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .pop-anim { animation: pop 0.4s; }

    </style>
</head>
<body>

    <div class="header">
        <div>
            <button class="nav-btn" onclick="toggleView('setupPhase')">ğŸ  ä¸“æ³¨</button>
            <button class="nav-btn" onclick="toggleView('shopPhase')">ğŸ›’ å•†åº—</button>
            <button class="nav-btn" onclick="toggleView('historyPhase')">ğŸ“œ å†å²</button>
        </div>
        <div class="coin-display">
            <span>ğŸ’°</span>
            <span id="totalCoins">0</span>
        </div>
    </div>

    <div id="setupPhase" class="container">
        <h2>ğŸš€ å¼€å¯æ–°ä»»åŠ¡</h2>
        <input type="text" id="taskName" placeholder="ä»»åŠ¡åç§°ï¼ˆä¾‹å¦‚ï¼šé˜…è¯» 20 é¡µï¼‰" autocomplete="off" />
        <input type="number" id="taskTime" placeholder="é¢„è®¡æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰" min="1" max="180" />
        <button class="btn" onclick="startFocus()">å¼€å§‹ä¸“æ³¨</button>
    </div>

    <div id="focusPhase" class="container hidden">
        <h3 id="currentTaskLabel" style="color:#7F8C8D; font-weight:normal;">ä»»åŠ¡è¿›è¡Œä¸­...</h3>
        <div class="timer-display" id="timerDisplay">00:00</div>
        <div style="margin-bottom:20px; color:#BDC3C7;">ä¿æŒä¸“æ³¨ï¼Œæ‹’ç»å¹²æ‰°</div>
        <button class="btn btn-finish" onclick="finishTask(false)">âœ… å®Œæˆä»»åŠ¡</button>
        <button class="btn btn-secondary" onclick="giveUp()">ğŸ³ï¸ æ”¾å¼ƒ</button>
    </div>

    <div id="feedbackPhase" class="container hidden">
        <h2>ğŸ“Š æˆæœè¯„ä¼°</h2>
        <p id="finishStatusLabel" style="color:#E67E22; font-weight:bold;">ä»»åŠ¡ç»“æŸ</p>
        
        <label>å®Œæˆåº¦: <span id="rangeValue" style="color:var(--primary-action); font-weight:bold;">100%</span></label>
        <input type="range" id="completionRate" min="0" max="100" value="100" oninput="updateRangeDisplay()">
        
        <div style="background: #FEF9E7; padding: 15px; border-radius: 12px; margin-top:15px; border: 1px solid #F1C40F;">
            <div style="color:#7F8C8D;">æœ¬æ¬¡å¥–åŠ±</div>
            <div style="font-size:1.5rem; font-weight:bold; color:#E67E22;">+ <span id="predictedCoins">0</span> ğŸ’°</div>
        </div>

        <button class="btn" onclick="claimReward()">æ”¶å…¥å›Šä¸­</button>
    </div>

    <div id="historyPhase" class="container hidden">
        <h2>ğŸ† å†å²æˆå°±</h2>
        <div id="historyListContainer" class="history-list"></div>
    </div>

    <div id="shopPhase" class="container hidden">
        <h2>ğŸ›ï¸ è§£å‹æ‚è´§é“º</h2>
        <p style="color:#7f8c8d; font-size:0.9rem;">ç”¨ä½ çš„ä¸“æ³¨åŠ›æ¢å–å¿«ä¹</p>
        
        <div id="shopGrid" class="shop-grid">
            </div>

        <button class="btn btn-secondary" style="margin-top:20px;" onclick="showAddProductModal()">+ è‡ªå®šä¹‰ä¸Šæ¶å•†å“</button>
    </div>

    <div id="addProductModal" class="container hidden" style="position:fixed; top:20%; left:50%; transform:translateX(-50%); z-index:200; border: 2px solid var(--primary-action);">
        <h3>âœ¨ ä¸Šæ¶æ–°å•†å“</h3>
        <input type="text" id="newProdName" placeholder="å•†å“åç§° (å¦‚: ä¹°ç›²ç›’)" />
        <input type="number" id="newProdPrice" placeholder="ä»·æ ¼ (1å…ƒ â‰ˆ 50é‡‘å¸)" />
        <input type="text" id="newProdIcon" placeholder="å›¾æ ‡ (è¾“å…¥Emoji æˆ– å›¾ç‰‡URL)" />
        <div style="display:flex; gap:10px;">
            <button class="btn btn-secondary" onclick="closeAddProductModal()">å–æ¶ˆ</button>
            <button class="btn" onclick="addNewProduct()">ä¸Šæ¶</button>
        </div>
    </div>

    <script>
        // --- å…¨å±€æ•°æ®ä¸é…ç½® ---
        let totalCoins = 0;
        let taskHistory = [];
        let shopItems = [];
        
        // é»˜è®¤å•†å“åˆ—è¡¨ (å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®æ—¶ä½¿ç”¨)
        const defaultShopItems = [
            { id: 1, name: "æ‘¸é±¼20åˆ†é’Ÿ", price: 200, icon: "ğŸ§˜" },
            { id: 2, name: "çœ‹ä¸€é›†åŠ¨æ¼«", price: 500, icon: "ğŸ“º" },
            { id: 3, name: "ä¸€æ¯å¥¶èŒ¶", price: 1000, icon: "ğŸ§‹" },
            { id: 4, name: "ä¹°æœ¬ä¹¦", price: 2000, icon: "ğŸ“š" },
            { id: 5, name: "ä¸“è¾‘/CDåŸºé‡‘", price: 500, icon: "ğŸ’¿" },
            { id: 6, name: "Steamæ¸¸æˆ", price: 3000, icon: "ğŸ®" }
        ];

        // è®¡æ—¶å™¨ç›¸å…³
        let timerInterval;
        let endTime = 0; 
        let plannedTimeMin = 0;
        let actualTimeMin = 0;
        let isTimeUp = false; 

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            // 1. è¯»å–é‡‘å¸
            const savedCoins = localStorage.getItem('adhd_coins');
            if (savedCoins) totalCoins = parseInt(savedCoins);
            updateCoinDisplay();

            // 2. è¯»å–å†å²
            const savedHistory = localStorage.getItem('adhd_task_history');
            if (savedHistory) taskHistory = JSON.parse(savedHistory);

            // 3. è¯»å–å•†åº—å•†å“
            const savedItems = localStorage.getItem('adhd_shop_items');
            if (savedItems) {
                shopItems = JSON.parse(savedItems);
            } else {
                shopItems = defaultShopItems; // åˆå§‹åŒ–é»˜è®¤å•†å“
                saveShopItems();
            }
        };

        // --- è§†å›¾åˆ‡æ¢ ---
        function toggleView(viewId) {
            // éšè—æ‰€æœ‰ä¸»è¦å®¹å™¨ (Modalé™¤å¤–)
            ['setupPhase', 'focusPhase', 'feedbackPhase', 'historyPhase', 'shopPhase'].forEach(pid => {
                document.getElementById(pid).classList.add('hidden');
            });
            
            // é€»è¾‘å¤„ç†
            if (viewId === 'historyPhase') renderHistoryList();
            if (viewId === 'shopPhase') renderShop();
            
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- ä¸“æ³¨é€»è¾‘ (å¤ç”¨ä¹‹å‰ç¨³å®šç‰ˆ) ---
        function startFocus() {
            const name = document.getElementById('taskName').value.trim();
            const time = parseInt(document.getElementById('taskTime').value);

            if (!name || !time) return alert("è¯·å¡«å†™ä»»åŠ¡å’Œæ—¶é—´");
            
            plannedTimeMin = time;
            isTimeUp = false;
            
            toggleView('focusPhase');
            document.getElementById('currentTaskLabel').innerText = name;
            
            endTime = Date.now() + (plannedTimeMin * 60 * 1000);
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                const remaining = updateTimerDisplay();
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    finishTask(true);
                }
            }, 1000);
        }

        function finishTask(autoFinished) {
            clearInterval(timerInterval);
            isTimeUp = autoFinished;
            
            if (autoFinished) {
                actualTimeMin = plannedTimeMin;
                document.getElementById('finishStatusLabel').innerText = `æ—¶é—´åˆ° (${actualTimeMin}åˆ†é’Ÿ)`;
            } else {
                const now = Date.now();
                const msPassed = (plannedTimeMin * 60 * 1000) - (endTime - now);
                actualTimeMin = Math.ceil(msPassed / 1000 / 60);
                if (actualTimeMin < 1) actualTimeMin = 1;
                document.getElementById('finishStatusLabel').innerText = `æå‰å®Œæˆ (${actualTimeMin}åˆ†é’Ÿ)`;
            }
            
            document.getElementById('completionRate').value = 100;
            updateRangeDisplay();
            toggleView('feedbackPhase');
        }

        function giveUp() {
            if(confirm("ç¡®å®šæ”¾å¼ƒå—ï¼Ÿ")) {
                clearInterval(timerInterval);
                toggleView('setupPhase');
            }
        }

        // --- ç»“ç®—ç³»ç»Ÿ ---
        function updateRangeDisplay() {
            const val = document.getElementById('completionRate').value;
            const el = document.getElementById('rangeValue');
            el.innerText = val + "%";
            el.style.color = val == 100 ? "#27ae60" : (val < 50 ? "#e74c3c" : "#FF6B6B");
            document.getElementById('predictedCoins').innerText = calculateReward();
        }

        function calculateReward() {
            const completion = parseInt(document.getElementById('completionRate').value) / 100;
            let reward = (actualTimeMin * 10) * Math.pow(completion, 2);
            
            if (!isTimeUp && completion === 1 && actualTimeMin < plannedTimeMin) {
                reward += (plannedTimeMin - actualTimeMin) * 5;
            }
            return Math.floor(reward);
        }

        function claimReward() {
            const reward = calculateReward();
            totalCoins += reward;
            saveCoins();
            
            // è®°å½•å†å²
            taskHistory.unshift({
                name: document.getElementById('taskName').value,
                coins: reward,
                date: new Date().toLocaleDateString(),
                duration: actualTimeMin,
                completion: document.getElementById('completionRate').value
            });
            localStorage.setItem('adhd_task_history', JSON.stringify(taskHistory));

            alert(`è·å¾— ${reward} é‡‘å¸ï¼`);
            document.getElementById('taskName').value = '';
            toggleView('setupPhase');
        }

        // --- å•†åº—ç³»ç»Ÿé€»è¾‘ (æ–°å¢æ ¸å¿ƒ) ---
        
        function renderShop() {
            const grid = document.getElementById('shopGrid');
            grid.innerHTML = '';

            shopItems.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'shop-item';
                
                // åˆ¤æ–­å›¾æ ‡æ˜¯ emoji è¿˜æ˜¯ å›¾ç‰‡URL
                let iconHtml = '';
                if (item.icon.match(/\.(jpeg|jpg|gif|png)$/) != null || item.icon.includes('http')) {
                     iconHtml = `<img src="${item.icon}" onerror="this.src='ğŸ'">`;
                } else {
                     iconHtml = item.icon; // Emoji
                }

                el.innerHTML = `
                    <button class="delete-item-btn" onclick="deleteProduct(${index}, event)">Ã—</button>
                    <div class="shop-icon">${iconHtml}</div>
                    <div class="shop-name">${item.name}</div>
                    <div class="shop-price">${item.price} ğŸ’°</div>
                `;
                
                el.onclick = (e) => {
                    if(e.target.classList.contains('delete-item-btn')) return;
                    buyItem(item);
                };
                
                grid.appendChild(el);
            });
        }

        function buyItem(item) {
            if (totalCoins >= item.price) {
                if(confirm(`ç¡®å®šèŠ±è´¹ ${item.price} é‡‘å¸å…‘æ¢ "${item.name}" å—ï¼Ÿ`)) {
                    totalCoins -= item.price;
                    saveCoins();
                    alert(`å…‘æ¢æˆåŠŸï¼äº«å—ä½ çš„ "${item.name}" å§ï¼ğŸ‰`);
                }
            } else {
                // é’±ä¸å¤Ÿçš„åŠ¨ç”»åé¦ˆ
                const coinEl = document.querySelector('.coin-display');
                coinEl.classList.add('shake-anim');
                setTimeout(() => coinEl.classList.remove('shake-anim'), 300);
                alert(`é‡‘å¸ä¸è¶³ï¼è¿˜å·® ${item.price - totalCoins} é‡‘å¸ï¼Œå¿«å»ä¸“æ³¨ä¸€ä¼šå§ï¼`);
            }
        }

        // è‡ªå®šä¹‰å•†å“ç›¸å…³
        function showAddProductModal() {
            document.getElementById('addProductModal').classList.remove('hidden');
        }
        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.add('hidden');
        }

        function addNewProduct() {
            const name = document.getElementById('newProdName').value;
            const price = parseInt(document.getElementById('newProdPrice').value);
            let icon = document.getElementById('newProdIcon').value;

            if(!name || !price) return alert("è¯·å¡«å†™åç§°å’Œä»·æ ¼");
            if(!icon) icon = "ğŸ"; // é»˜è®¤å›¾æ ‡

            shopItems.push({ name, price, icon });
            saveShopItems();
            
            // é‡ç½®å¹¶å…³é—­
            document.getElementById('newProdName').value = '';
            document.getElementById('newProdPrice').value = '';
            document.getElementById('newProdIcon').value = '';
            closeAddProductModal();
            renderShop();
        }

        function deleteProduct(index, event) {
            event.stopPropagation();
            if(confirm("ç¡®å®šä¸‹æ¶è¿™ä¸ªå•†å“å—ï¼Ÿ")) {
                shopItems.splice(index, 1);
                saveShopItems();
                renderShop();
            }
        }

        function saveShopItems() {
            localStorage.setItem('adhd_shop_items', JSON.stringify(shopItems));
        }

        // --- é€šç”¨è¾…åŠ© ---
        function updateTimerDisplay() {
            const now = Date.now();
            let remaining = Math.ceil((endTime - now) / 1000);
            if (remaining < 0) remaining = 0;

            const m = Math.floor(remaining / 60).toString().padStart(2, '0');
            const s = (remaining % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').innerText = `${m}:${s}`;
            return remaining;
        }

        function saveCoins() {
            localStorage.setItem('adhd_coins', totalCoins);
            updateCoinDisplay();
        }

        function updateCoinDisplay() {
            const el = document.getElementById('totalCoins');
            el.innerText = totalCoins;
            el.classList.remove('pop-anim');
            void el.offsetWidth; 
            el.classList.add('pop-anim');
        }

        function renderHistoryList() {
            const container = document.getElementById('historyListContainer');
            container.innerHTML = '';
            if (taskHistory.length === 0) {
                container.innerHTML = '<div style="color:#999;font-style:italic">æš‚æ— è®°å½•</div>';
                return;
            }
            taskHistory.forEach(task => {
                const div = document.createElement('div');
                div.className = `history-card ${task.completion == 100 ? 'perfect' : ''}`;
                div.innerHTML = `<div><strong>${task.name}</strong></div><div style="font-size:0.8rem;color:#666">${task.date} | +${task.coins}ğŸ’°</div>`;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>