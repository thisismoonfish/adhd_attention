<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADHD ä¸“æ³¨è§„åˆ’å™¨ v2.0</title>
    <style>
        :root {
            --bg-color: #F4F7F6;
            --text-color: #2C3E50;
            --primary-action: #FF6B6B;
            --focus-color: #1DD1A1;
            --gold-color: #FDCB6E;
            --card-bg: #FFFFFF;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* --- é¡¶éƒ¨å¯¼èˆªæ  --- */
        .header {
            width: 100%;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            box-sizing: border-box;
        }

        .coin-display {
            font-weight: 800;
            color: #E67E22;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .history-btn {
            background: none;
            border: 2px solid #EEE;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #7f8c8d;
            transition: all 0.2s;
        }
        .history-btn:hover { background: #f0f0f0; color: #333; }

        /* --- ä¸»å®¹å™¨é€šç”¨æ ·å¼ --- */
        .container {
            width: 100%;
            max-width: 400px;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: center;
            transition: all 0.3s ease;
            box-sizing: border-box;
            position: relative;
        }

        h2 { margin-top: 0; color: var(--text-color); font-size: 1.5rem; }
        
        /* --- è¾“å…¥æ¡†ä¸æ§ä»¶ --- */
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #F0F0F0;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus { border-color: var(--primary-action); outline: none; }

        input[type="range"] { width: 100%; margin: 25px 0; cursor: pointer; }

        /* --- æŒ‰é’® --- */
        .btn {
            width: 100%;
            padding: 16px;
            background-color: var(--primary-action);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background-color: #95A5A6; }
        .btn-finish { background-color: var(--focus-color); }
        .btn-close { background: #eee; color: #666; margin-top: 10px; }

        /* --- ä¸“æ³¨å€’è®¡æ—¶ --- */
        .timer-display {
            font-size: 4.5rem;
            font-weight: 800;
            color: var(--focus-color);
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
        }

        /* --- å†å²è®°å½•åˆ—è¡¨ --- */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            margin-top: 10px;
        }
        
        .history-card {
            background: #F8F9FA;
            border-left: 5px solid #DDD;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            position: relative;
        }
        
        /* å®Œç¾å®Œæˆçš„ç‰¹æ®Šæ ·å¼ */
        .history-card.perfect {
            border-left-color: var(--gold-color);
            background: #FEF9E7;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-meta {
            font-size: 0.85rem;
            color: #7F8C8D;
            display: flex;
            justify-content: space-between;
        }

        .coin-badge {
            background: #FFEAA7;
            color: #D35400;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .empty-state { color: #999; margin: 30px 0; font-style: italic; }

        /* --- å·¥å…·ç±» --- */
        .hidden { display: none !important; }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .pop-anim { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    </style>
</head>
<body>

    <div class="header">
        <button class="history-btn" onclick="toggleHistory()">ğŸ“œ å†å²è®°å½•</button>
        <div class="coin-display">
            <span>ğŸ’°</span>
            <span id="totalCoins">0</span>
        </div>
    </div>

    <div id="setupPhase" class="container">
        <h2>ğŸš€ å¼€å¯æ–°ä»»åŠ¡</h2>
        <input type="text" id="taskName" placeholder="ä»»åŠ¡åç§°ï¼ˆä¾‹å¦‚ï¼šèƒŒå•è¯ 50 ä¸ªï¼‰" autocomplete="off" />
        <input type="number" id="taskTime" placeholder="é¢„è®¡æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰" min="1" max="180" />
        <button class="btn" onclick="startFocus()">å¼€å§‹ä¸“æ³¨</button>
    </div>

    <div id="focusPhase" class="container hidden">
        <h3 id="currentTaskLabel" style="color:#7F8C8D; font-weight:normal;">ä»»åŠ¡è¿›è¡Œä¸­...</h3>
        <div class="timer-display" id="timerDisplay">00:00</div>
        <div style="margin-bottom:20px; color:#BDC3C7; font-size:0.9rem;">ä¿æŒä¸“æ³¨ï¼Œæ‹’ç»å¹²æ‰°</div>
        <button class="btn btn-finish" onclick="finishEarly()">âœ… å®Œæˆä»»åŠ¡</button>
        <button class="btn btn-secondary" onclick="giveUp()">ğŸ³ï¸ æ”¾å¼ƒ</button>
    </div>

    <div id="feedbackPhase" class="container hidden">
        <h2>ğŸ“Š æˆæœè¯„ä¼°</h2>
        <p style="color:#7F8C8D; margin-bottom: 5px;">å®é™…ä¸“æ³¨æ—¶é•¿</p>
        <div style="font-size: 2rem; font-weight:bold; color:var(--text-color); margin-bottom:20px;">
            <span id="actualTimeDisplay">0</span> <span style="font-size:1rem;">åˆ†é’Ÿ</span>
        </div>
        
        <label>ä»»åŠ¡å®Œæˆåº¦: <span id="rangeValue" style="color:var(--primary-action); font-weight:bold; font-size:1.2rem;">50%</span></label>
        <input type="range" id="completionRate" min="0" max="100" value="50" oninput="updateRangeDisplay()">
        
        <div style="background: #FEF9E7; padding: 15px; border-radius: 12px; margin-top:15px; border: 1px solid #F1C40F;">
            <div style="color:#7F8C8D; font-size:0.9rem;">æœ¬æ¬¡å¥–åŠ±</div>
            <div style="font-size:1.5rem; font-weight:bold; color:#E67E22;">+ <span id="predictedCoins">0</span> ğŸ’°</div>
        </div>

        <button class="btn" onclick="claimReward()">æ”¶å…¥å›Šä¸­</button>
    </div>

    <div id="historyPhase" class="container hidden">
        <h2>ğŸ† å†å²æˆå°±</h2>
        <div id="historyListContainer" class="history-list">
            </div>
        <button class="btn btn-close" onclick="toggleHistory()">å…³é—­</button>
    </div>

    <script>
        // --- å…¨å±€å˜é‡ ---
        let totalCoins = 0;
        let taskHistory = []; // å­˜å‚¨å†å²ä»»åŠ¡å¯¹è±¡
        
        // è®¡æ—¶å™¨ç›¸å…³
        let timerInterval;
        let plannedTimeMin = 0;
        let startTime = 0;
        let actualTimeMin = 0;

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            // è¯»å–é‡‘å¸
            const savedCoins = localStorage.getItem('adhd_coins');
            if (savedCoins) totalCoins = parseInt(savedCoins);
            
            // è¯»å–å†å²è®°å½•
            const savedHistory = localStorage.getItem('adhd_task_history');
            if (savedHistory) {
                try {
                    taskHistory = JSON.parse(savedHistory);
                } catch(e) {
                    console.error("å†å²è®°å½•è§£æå¤±è´¥", e);
                    taskHistory = [];
                }
            }
            
            updateCoinDisplay();
        };

        // --- æ ¸å¿ƒæµç¨‹å‡½æ•° ---

        function startFocus() {
            const nameInput = document.getElementById('taskName');
            const timeInput = document.getElementById('taskTime');
            
            const name = nameInput.value.trim();
            const time = parseInt(timeInput.value);

            if (!name) return alert("å†™ä¸ªä»»åŠ¡åå§ï¼Œå“ªæ€•å¾ˆç®€å•ï¼");
            if (!time || time <= 0) return alert("æ—¶é—´è¦è®¾ç½®å¾—åˆç†å“¦ï¼ˆè‡³å°‘1åˆ†é’Ÿï¼‰");

            plannedTimeMin = time;
            let remainingSeconds = plannedTimeMin * 60;
            
            showSection('focusPhase');
            document.getElementById('currentTaskLabel').innerText = name;
            
            startTime = Date.now();
            updateTimerDisplay(remainingSeconds);

            // è®¡æ—¶é€»è¾‘
            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay(remainingSeconds);
                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    finishEarly(); 
                }
            }, 1000);
        }

        function finishEarly() {
            clearInterval(timerInterval);
            const elapsedSeconds = (Date.now() - startTime) / 1000;
            actualTimeMin = Math.ceil(elapsedSeconds / 60);
            if (actualTimeMin < 1) actualTimeMin = 1; // è‡³å°‘ç®—1åˆ†é’Ÿ

            document.getElementById('actualTimeDisplay').innerText = actualTimeMin;
            
            // é‡ç½®æ»‘å—ä¸ºé«˜é¢‘é»˜è®¤å€¼ (ADHDé€šå¸¸è¦ä¹ˆåšå®Œè¦ä¹ˆæ²¡åšï¼Œè®¾ä¸º80å¼•å¯¼ç§¯ææ€§)
            document.getElementById('completionRate').value = 100; 
            updateRangeDisplay();
            
            showSection('feedbackPhase');
        }

        function giveUp() {
            if(confirm("ç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿè¿™æ¬¡çš„ä¸“æ³¨å°†ä¸ä¼šè¢«è®°å½•ã€‚")) {
                clearInterval(timerInterval);
                document.getElementById('taskName').value = ''; 
                showSection('setupPhase');
            }
        }

        function claimReward() {
            const reward = calculateRewardValue();
            const taskName = document.getElementById('taskName').value;
            const completion = parseInt(document.getElementById('completionRate').value);

            // 1. æ›´æ–°é‡‘å¸
            totalCoins += reward;
            localStorage.setItem('adhd_coins', totalCoins);
            updateCoinDisplay();

            // 2. è®°å½•åˆ°å†å²
            const record = {
                id: Date.now(),
                name: taskName,
                duration: actualTimeMin,
                planDuration: plannedTimeMin,
                completion: completion,
                coins: reward,
                date: new Date().toLocaleString()
            };
            
            // æ–°è®°å½•æ’åˆ°æœ€å‰é¢
            taskHistory.unshift(record);
            // é™åˆ¶ä¿å­˜æœ€è¿‘50æ¡ï¼Œé˜²æ­¢å­˜å‚¨æº¢å‡º
            if(taskHistory.length > 50) taskHistory.pop();
            
            localStorage.setItem('adhd_task_history', JSON.stringify(taskHistory));

            alert(`å¤ªæ£’äº†ï¼æ”¶å…¥ ${reward} é‡‘å¸ï¼`);
            
            // 3. æ¸…ç†å¹¶è¿”å›
            document.getElementById('taskName').value = '';
            document.getElementById('taskTime').value = '';
            showSection('setupPhase');
        }

        // --- è¾…åŠ©é€»è¾‘ ---

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').innerText = `${m}:${s}`;
        }

        function updateRangeDisplay() {
            const val = document.getElementById('completionRate').value;
            document.getElementById('rangeValue').innerText = val + "%";
            
            // åŠ¨æ€æ”¹å˜é¢œè‰²åé¦ˆ
            const label = document.getElementById('rangeValue');
            if(val == 100) label.style.color = "#27ae60";
            else if(val < 50) label.style.color = "#e74c3c";
            else label.style.color = "var(--primary-action)";

            document.getElementById('predictedCoins').innerText = calculateRewardValue();
        }

        function calculateRewardValue() {
            const completion = parseInt(document.getElementById('completionRate').value);
            const c_factor = completion / 100;
            const baseRate = 10;
            
            let reward = (actualTimeMin * baseRate) * Math.pow(c_factor, 2);
            
            // æ—©é¸Ÿå¥–åŠ±é€»è¾‘
            if (completion === 100 && actualTimeMin < plannedTimeMin) {
                reward += (plannedTimeMin - actualTimeMin) * 5;
            }
            return Math.floor(reward);
        }

        function updateCoinDisplay() {
            const el = document.getElementById('totalCoins');
            el.innerText = totalCoins;
            el.classList.remove('pop-anim');
            void el.offsetWidth; 
            el.classList.add('pop-anim');
        }

        // --- è§†å›¾ç®¡ç† ---

        function showSection(id) {
            // éšè—æ‰€æœ‰ä¸»è¦å®¹å™¨
            ['setupPhase', 'focusPhase', 'feedbackPhase', 'historyPhase'].forEach(pid => {
                document.getElementById(pid).classList.add('hidden');
            });
            // æ˜¾ç¤ºç›®æ ‡å®¹å™¨
            document.getElementById(id).classList.remove('hidden');
        }

        function toggleHistory() {
            const historyDiv = document.getElementById('historyPhase');
            const setupDiv = document.getElementById('setupPhase');
            
            if (historyDiv.classList.contains('hidden')) {
                // æ‰“å¼€å†å²è®°å½•ï¼šæ¸²æŸ“åˆ—è¡¨ï¼Œéšè—å½“å‰çš„è®¾å®šç•Œé¢
                renderHistoryList();
                showSection('historyPhase');
            } else {
                // å…³é—­å†å²è®°å½•ï¼šå›åˆ°è®¾å®šç•Œé¢
                showSection('setupPhase');
            }
        }

        function renderHistoryList() {
            const container = document.getElementById('historyListContainer');
            container.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

            if (taskHistory.length === 0) {
                container.innerHTML = '<div class="empty-state">è¿˜æ²¡æœ‰ä»»åŠ¡è®°å½•ï¼Œå¿«å»å®Œæˆç¬¬ä¸€ä¸ªä»»åŠ¡å§ï¼</div>';
                return;
            }

            taskHistory.forEach(task => {
                const isPerfect = task.completion === 100;
                // åˆ›å»ºå¡ç‰‡ HTML
                const card = document.createElement('div');
                card.className = `history-card ${isPerfect ? 'perfect' : ''}`;
                
                card.innerHTML = `
                    <div class="history-header">
                        <span>${task.name}</span>
                        <span class="coin-badge">+${task.coins} ğŸ’°</span>
                    </div>
                    <div class="history-meta">
                        <span>â±ï¸ ${task.duration}åˆ†é’Ÿ / ğŸ“… ${task.completion}% å®Œæˆ</span>
                        <span style="font-size:0.75rem">${task.date.split(' ')[0]}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>